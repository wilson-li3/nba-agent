<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ball Don't Lie — NBA Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked@11/marked.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  --orange:#D4782F;
  --orange-light:#F0C9A0;
  --orange-pale:#FDF0E2;
  --cream:#FBF8F4;
  --cream-dark:#F3EDE5;
  --text:#2D2D2D;
  --text-mid:#6B6B6B;
  --text-light:#A0A0A0;
  --border:#E3D6C8;
}

html,body{
  height:100%;
  font-family:'DM Sans',system-ui,-apple-system,sans-serif;
  background:var(--cream);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
}

/* ─── APP SHELL ─── */
.app{
  display:flex;
  flex-direction:column;
  height:100vh;
  max-width:860px;
  margin:0 auto;
  position:relative;
}

/* ─── HEADLINES ─── */
.headlines-bar{
  padding:20px 32px 16px;
  border-bottom:1px solid var(--border);
}
.headlines-label{
  font-family:'Gaegu',cursive;
  font-size:1.35rem;
  color:var(--orange);
  font-weight:700;
  display:inline;
}
.headlines-items{
  display:inline;
  font-size:0.88rem;
  color:var(--text-light);
  font-style:italic;
  margin-left:6px;
}

/* ─── SCORES TICKER ─── */
.scores-bar{
  padding:12px 32px;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  gap:10px;
  font-size:0.84rem;
  color:var(--text-light);
}
.scores-bar .placeholder{font-style:italic;}
.scores-bar .view-all{
  margin-left:auto;
  font-family:'Gaegu',cursive;
  font-size:1rem;
  color:var(--orange);
  opacity:0.45;
  cursor:default;
}

/* ─── LANDING (centered branding + input) ─── */
.landing{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:28px;
  padding:0 32px 60px;
  transition:opacity 0.35s ease, transform 0.35s ease;
}
.landing.hidden{
  opacity:0;
  pointer-events:none;
  position:absolute;
  transform:translateY(-20px);
}

.logo{display:flex;align-items:center;gap:14px;}

/* Basketball + Hoop SVG */
.logo-icon{width:52px;height:52px;}

.brand-text{
  font-family:'Gaegu',cursive;
  font-size:1.9rem;
  font-weight:700;
  color:var(--orange);
  letter-spacing:1.5px;
  text-transform:uppercase;
}

/* ─── CHAT VIEW (hidden until first message) ─── */
.chat-view{
  flex:1;
  display:none;
  flex-direction:column;
  overflow:hidden;
}
.chat-view.active{display:flex;}

/* Mini header in chat mode */
.chat-header{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:14px 32px;
  border-bottom:1px solid var(--border);
}
.chat-header .logo-icon{width:28px;height:28px;}
.chat-header .brand-text{font-size:1.1rem;letter-spacing:1px;}

/* Messages */
.messages{
  flex:1;
  overflow-y:auto;
  padding:20px 32px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

.message{
  max-width:82%;
  padding:14px 18px;
  border-radius:18px;
  font-size:0.9rem;
  line-height:1.65;
  animation:msgIn 0.3s ease;
}
@keyframes msgIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

.message.user{
  align-self:flex-end;
  background:var(--orange);
  color:white;
  border-bottom-right-radius:4px;
  font-weight:500;
}

.message.assistant{
  align-self:flex-start;
  background:white;
  border:1px solid var(--border);
  border-bottom-left-radius:4px;
}

.message .category-badge{
  display:inline-block;
  font-size:0.68rem;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:0.6px;
  background:var(--orange-pale);
  color:var(--orange);
  padding:3px 10px;
  border-radius:10px;
  margin-bottom:8px;
}

.message .sql-block{
  margin-top:10px;
  padding:10px 14px;
  background:var(--cream);
  border-radius:10px;
  font-family:'SF Mono','Fira Code','Cascadia Code',monospace;
  font-size:0.76rem;
  color:var(--text-mid);
  overflow-x:auto;
  white-space:pre;
  border:1px solid var(--border);
}

.message .sources{margin-top:10px;font-size:0.78rem;color:var(--text-light);}
.message .sources a{color:var(--orange);text-decoration:none;}
.message .sources a:hover{text-decoration:underline;}

/* ─── BOUNCING BASKETBALL LOADER ─── */
.loading{
  align-self:flex-start;
  display:flex;
  align-items:flex-end;
  gap:8px;
  padding:10px 4px;
  animation:msgIn 0.3s ease;
}
.loading svg{
  width:32px;height:32px;
  animation:ballBounce 0.6s ease-in-out infinite;
}
.loading-text{
  font-size:0.8rem;
  color:var(--text-light);
  font-style:italic;
  padding-bottom:4px;
}
@keyframes ballBounce{
  0%{transform:translateY(0) scale(1,1)}
  15%{transform:translateY(-18px) scale(0.95,1.05)}
  30%{transform:translateY(-28px) scale(0.95,1.05)}
  50%{transform:translateY(-30px) scale(1,1)}
  70%{transform:translateY(-18px) scale(1,1)}
  85%{transform:translateY(-4px) scale(1.05,0.92)}
  100%{transform:translateY(0) scale(1,1)}
}
/* Shadow under the ball */
.loading .ball-shadow{
  width:24px;height:6px;
  background:radial-gradient(ellipse, rgba(0,0,0,0.12) 0%, transparent 70%);
  border-radius:50%;
  animation:shadowPulse 0.6s ease-in-out infinite;
  align-self:flex-end;
  margin-bottom:2px;
  margin-left:-36px;
}
@keyframes shadowPulse{
  0%{transform:scaleX(1);opacity:0.5}
  50%{transform:scaleX(0.6);opacity:0.2}
  100%{transform:scaleX(1);opacity:0.5}
}

/* ─── INPUT AREA ─── */
.input-area{padding:12px 32px 28px;}

/* Centered mode (landing) */
.landing .input-area{
  padding:0;
  width:100%;
  max-width:560px;
}

.input-bubble{
  display:flex;
  align-items:center;
  gap:10px;
  background:white;
  border:2px solid var(--orange-light);
  border-radius:30px;
  padding:8px 8px 8px 6px;
  position:relative;
  transition:border-color 0.2s, box-shadow 0.2s;
}
.input-bubble:focus-within{
  border-color:var(--orange);
  box-shadow:0 0 0 3px rgba(212,120,47,0.1);
}

/* Speech bubble tail */
.input-bubble::after{
  content:'';
  position:absolute;
  bottom:-11px;
  left:30px;
  width:0;height:0;
  border-left:11px solid transparent;
  border-right:11px solid transparent;
  border-top:11px solid var(--orange-light);
  transition:border-top-color 0.2s;
}
.input-bubble:focus-within::after{
  border-top-color:var(--orange);
}
.input-bubble::before{
  content:'';
  position:absolute;
  bottom:-8px;
  left:31.5px;
  width:0;height:0;
  border-left:9.5px solid transparent;
  border-right:9.5px solid transparent;
  border-top:9.5px solid white;
  z-index:1;
}

.input-bubble .ball-icon{
  flex-shrink:0;
  width:34px;height:34px;
  margin-left:6px;
}

.input-bubble input{
  flex:1;
  border:none;
  outline:none;
  font-size:0.95rem;
  font-family:'DM Sans',sans-serif;
  color:var(--text);
  background:transparent;
}
.input-bubble input::placeholder{color:var(--text-light);}

.input-bubble button{
  flex-shrink:0;
  background:var(--orange-pale);
  color:var(--orange);
  border:2px solid var(--orange-light);
  border-radius:22px;
  padding:9px 22px;
  font-size:0.9rem;
  font-weight:600;
  font-family:'DM Sans',sans-serif;
  cursor:pointer;
  transition:all 0.2s;
}
.input-bubble button:hover{
  background:var(--orange);
  color:white;
  border-color:var(--orange);
}
.input-bubble button:disabled{opacity:0.4;cursor:not-allowed;}
.input-bubble button:disabled:hover{
  background:var(--orange-pale);color:var(--orange);border-color:var(--orange-light);
}

/* Tail spacing */
.input-area{padding-bottom:36px;}
.landing .input-area{padding-bottom:0;}

/* ─── HEADLINES LINKS ─── */
.headlines-items a{
  color:var(--text-mid);
  text-decoration:none;
  transition:color 0.2s;
}
.headlines-items a:hover{
  color:var(--orange);
  text-decoration:underline;
}

/* ─── GAME CHIPS ─── */
.game-chip{
  display:inline-flex;
  align-items:center;
  gap:4px;
  padding:4px 10px;
  border:1px solid var(--border);
  border-radius:14px;
  font-size:0.78rem;
  font-weight:500;
  white-space:nowrap;
  background:white;
}
.live-dot{
  width:6px;height:6px;
  border-radius:50%;
  background:#22c55e;
  animation:livePulse 1.5s ease-in-out infinite;
}
@keyframes livePulse{
  0%,100%{opacity:1}
  50%{opacity:0.3}
}
.team-logo{
  width:18px; height:18px;
  object-fit:contain;
  vertical-align:middle;
}

/* ─── MARKDOWN IN ASSISTANT MESSAGES ─── */
.message.assistant h1,.message.assistant h2,.message.assistant h3,
.message.assistant h4,.message.assistant h5,.message.assistant h6{
  margin:12px 0 6px;
  font-weight:700;
  line-height:1.3;
}
.message.assistant h1{font-size:1.15rem;}
.message.assistant h2{font-size:1.05rem;}
.message.assistant h3{font-size:0.95rem;}

.message.assistant p{margin:6px 0;}

.message.assistant ul,.message.assistant ol{
  margin:6px 0;
  padding-left:20px;
}
.message.assistant li{margin:3px 0;}

.message.assistant table{
  width:100%;
  border-collapse:collapse;
  margin:10px 0;
  font-size:0.82rem;
}
.message.assistant thead tr{
  background:var(--orange);
  color:white;
}
.message.assistant th,.message.assistant td{
  padding:6px 10px;
  border:1px solid var(--border);
  text-align:left;
}
.message.assistant tbody tr:nth-child(even){
  background:var(--cream);
}

.message.assistant pre{
  margin:8px 0;
  padding:10px 14px;
  background:var(--cream);
  border-radius:10px;
  font-family:'SF Mono','Fira Code','Cascadia Code',monospace;
  font-size:0.76rem;
  color:var(--text-mid);
  overflow-x:auto;
  border:1px solid var(--border);
}
.message.assistant code{
  font-family:'SF Mono','Fira Code','Cascadia Code',monospace;
  font-size:0.82em;
  background:var(--cream);
  padding:1px 4px;
  border-radius:4px;
}
.message.assistant pre code{
  background:none;
  padding:0;
}

.message.assistant hr{
  border:none;
  border-top:1px solid var(--border);
  margin:12px 0;
}

.message.assistant blockquote{
  border-left:3px solid var(--orange-light);
  padding-left:12px;
  margin:8px 0;
  color:var(--text-mid);
}

@media(max-width:640px){
  .app{max-width:100%;}
  .message{max-width:90%;}
  .brand-text{font-size:1.5rem;}
  .headlines-bar,.scores-bar,.messages,.input-area{padding-left:16px;padding-right:16px;}
  .chat-header{padding-left:16px;padding-right:16px;}
}
</style>
</head>
<body>
<div class="app">

  <!-- Headlines -->
  <div class="headlines-bar">
    <span class="headlines-label">Headlines</span>
    <span class="headlines-items" id="headlinesItems">No headlines yet — connect a news source to see live updates.</span>
  </div>

  <!-- Scores ticker -->
  <div class="scores-bar">
    <span id="scoresContent">Live scores coming soon</span>
  </div>

  <!-- LANDING PAGE (centered branding + input) -->
  <div class="landing" id="landing">
    <div class="logo">
      <svg class="logo-icon" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- Backboard -->
        <rect x="36" y="6" width="48" height="5" rx="2" fill="#3A3A3A"/>
        <!-- Backboard support -->
        <rect x="58" y="11" width="4" height="14" rx="1" fill="#3A3A3A"/>
        <!-- Rim -->
        <ellipse cx="60" cy="28" rx="18" ry="5" stroke="#D4782F" stroke-width="2.5" fill="none"/>
        <!-- Net -->
        <path d="M42 30 C45 40,48 46,51 52" stroke="#C8B8A4" stroke-width="1.2" fill="none" stroke-linecap="round"/>
        <path d="M48 31 C50 40,52 46,54 52" stroke="#C8B8A4" stroke-width="1.2" fill="none" stroke-linecap="round"/>
        <path d="M54 32 C56 40,57 46,57 52" stroke="#C8B8A4" stroke-width="1.2" fill="none" stroke-linecap="round"/>
        <path d="M60 33 C60 40,60 46,60 52" stroke="#C8B8A4" stroke-width="1.2" fill="none" stroke-linecap="round"/>
        <path d="M66 32 C64 40,63 46,63 52" stroke="#C8B8A4" stroke-width="1.2" fill="none" stroke-linecap="round"/>
        <path d="M72 31 C70 40,68 46,66 52" stroke="#C8B8A4" stroke-width="1.2" fill="none" stroke-linecap="round"/>
        <path d="M78 30 C75 40,72 46,69 52" stroke="#C8B8A4" stroke-width="1.2" fill="none" stroke-linecap="round"/>
        <!-- Cross net threads -->
        <path d="M44 36 Q60 40,76 36" stroke="#C8B8A4" stroke-width="0.8" fill="none"/>
        <path d="M48 44 Q60 48,72 44" stroke="#C8B8A4" stroke-width="0.8" fill="none"/>
        <!-- Basketball -->
        <circle cx="60" cy="82" r="24" fill="#D4782F"/>
        <circle cx="60" cy="82" r="24" stroke="#2D2D2D" stroke-width="1.8" fill="none"/>
        <!-- Horizontal seam -->
        <line x1="36" y1="82" x2="84" y2="82" stroke="#2D2D2D" stroke-width="1.4"/>
        <!-- Vertical seam -->
        <line x1="60" y1="58" x2="60" y2="106" stroke="#2D2D2D" stroke-width="1.4"/>
        <!-- Left curved seam -->
        <path d="M60 58 C44 68, 44 96, 60 106" stroke="#2D2D2D" stroke-width="1.4" fill="none"/>
        <!-- Right curved seam -->
        <path d="M60 58 C76 68, 76 96, 60 106" stroke="#2D2D2D" stroke-width="1.4" fill="none"/>
        <!-- Highlight -->
        <ellipse cx="50" cy="73" rx="5" ry="7" fill="rgba(255,255,255,0.18)" transform="rotate(-25 50 73)"/>
      </svg>
      <span class="brand-text">Ball Don't Lie</span>
    </div>

    <!-- Input (centered on landing) -->
    <div class="input-area">
      <form class="input-bubble" id="chatForm" autocomplete="off">
        <svg class="ball-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
          <circle cx="24" cy="24" r="20" fill="#D4782F"/>
          <circle cx="24" cy="24" r="20" stroke="#2D2D2D" stroke-width="1.2" fill="none"/>
          <line x1="4" y1="24" x2="44" y2="24" stroke="#2D2D2D" stroke-width="1"/>
          <line x1="24" y1="4" x2="24" y2="44" stroke="#2D2D2D" stroke-width="1"/>
          <path d="M24 4 C16 12, 16 36, 24 44" stroke="#2D2D2D" stroke-width="1" fill="none"/>
          <path d="M24 4 C32 12, 32 36, 24 44" stroke="#2D2D2D" stroke-width="1" fill="none"/>
          <ellipse cx="19" cy="18" rx="3" ry="4" fill="rgba(255,255,255,0.18)" transform="rotate(-25 19 18)"/>
        </svg>
        <input type="text" id="questionInput" placeholder="Ask me anything NBA-related" required>
        <button type="submit" id="sendBtn">Send</button>
      </form>
    </div>
  </div>

  <!-- CHAT VIEW (shown after first message) -->
  <div class="chat-view" id="chatView">
    <div class="chat-header">
      <svg class="logo-icon" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="36" y="6" width="48" height="5" rx="2" fill="#3A3A3A"/>
        <rect x="58" y="11" width="4" height="14" rx="1" fill="#3A3A3A"/>
        <ellipse cx="60" cy="28" rx="18" ry="5" stroke="#D4782F" stroke-width="2.5" fill="none"/>
        <path d="M42 30 C45 40,48 46,51 52" stroke="#C8B8A4" stroke-width="1.2" fill="none" stroke-linecap="round"/>
        <path d="M48 31 C50 40,52 46,54 52" stroke="#C8B8A4" stroke-width="1.2" fill="none" stroke-linecap="round"/>
        <path d="M54 32 C56 40,57 46,57 52" stroke="#C8B8A4" stroke-width="1.2" fill="none" stroke-linecap="round"/>
        <path d="M60 33 C60 40,60 46,60 52" stroke="#C8B8A4" stroke-width="1.2" fill="none" stroke-linecap="round"/>
        <path d="M66 32 C64 40,63 46,63 52" stroke="#C8B8A4" stroke-width="1.2" fill="none" stroke-linecap="round"/>
        <path d="M72 31 C70 40,68 46,66 52" stroke="#C8B8A4" stroke-width="1.2" fill="none" stroke-linecap="round"/>
        <path d="M78 30 C75 40,72 46,69 52" stroke="#C8B8A4" stroke-width="1.2" fill="none" stroke-linecap="round"/>
        <path d="M44 36 Q60 40,76 36" stroke="#C8B8A4" stroke-width="0.8" fill="none"/>
        <path d="M48 44 Q60 48,72 44" stroke="#C8B8A4" stroke-width="0.8" fill="none"/>
        <circle cx="60" cy="82" r="24" fill="#D4782F"/>
        <circle cx="60" cy="82" r="24" stroke="#2D2D2D" stroke-width="1.8" fill="none"/>
        <line x1="36" y1="82" x2="84" y2="82" stroke="#2D2D2D" stroke-width="1.4"/>
        <line x1="60" y1="58" x2="60" y2="106" stroke="#2D2D2D" stroke-width="1.4"/>
        <path d="M60 58 C44 68, 44 96, 60 106" stroke="#2D2D2D" stroke-width="1.4" fill="none"/>
        <path d="M60 58 C76 68, 76 96, 60 106" stroke="#2D2D2D" stroke-width="1.4" fill="none"/>
        <ellipse cx="50" cy="73" rx="5" ry="7" fill="rgba(255,255,255,0.18)" transform="rotate(-25 50 73)"/>
      </svg>
      <span class="brand-text">Ball Don't Lie</span>
    </div>

    <div class="messages" id="messages"></div>

    <!-- Input (bottom-pinned in chat mode) -->
    <div class="input-area" id="chatInputArea"></div>
  </div>

</div>

<script>
marked.use({ breaks: true, gfm: true });

const form = document.getElementById('chatForm');
const input = document.getElementById('questionInput');
const sendBtn = document.getElementById('sendBtn');
const messagesEl = document.getElementById('messages');
const landingEl = document.getElementById('landing');
const chatViewEl = document.getElementById('chatView');
const chatInputArea = document.getElementById('chatInputArea');
const headlinesItems = document.getElementById('headlinesItems');
const scoresContent = document.getElementById('scoresContent');
let chatActive = false;
let conversationHistory = [];

// ─── Headlines ───
async function fetchHeadlines() {
  try {
    const res = await fetch('/headlines');
    const data = await res.json();
    if (data.headlines && data.headlines.length > 0) {
      headlinesItems.innerHTML = data.headlines.map(h =>
        h.url
          ? `<a href="${escapeHtml(h.url)}" target="_blank">${escapeHtml(h.title)}</a>`
          : escapeHtml(h.title)
      ).join(' &middot; ');
    }
  } catch (e) { /* keep placeholder */ }
}

function teamLogo(teamId) {
  if (!teamId) return '';
  return `<img src="https://cdn.nba.com/logos/nba/${teamId}/primary/L/logo.svg" class="team-logo" alt="">`;
}

// ─── Scores ───
async function fetchScores() {
  try {
    const res = await fetch('/scores');
    const data = await res.json();
    if (data.games && data.games.length > 0) {
      const label = data.label ? `<strong>${escapeHtml(data.label)}</strong> ` : '';
      const chips = data.games.map(g => {
        const hasScore = g.home_pts != null && g.away_pts != null;
        const statusText = g.game_status_text || '';
        const isLive = statusText.match(/^\d/) && !statusText.match(/final/i);
        const liveDot = isLive ? '<span class="live-dot"></span>' : '';
        if (hasScore) {
          return `<span class="game-chip">${liveDot}${teamLogo(g.away_team_id)}${escapeHtml(g.away_team_abbr)} ${g.away_pts} - ${g.home_pts} ${teamLogo(g.home_team_id)}${escapeHtml(g.home_team_abbr)} <small>${escapeHtml(statusText)}</small></span>`;
        } else {
          return `<span class="game-chip">${teamLogo(g.away_team_id)}${escapeHtml(g.away_team_abbr)} @ ${teamLogo(g.home_team_id)}${escapeHtml(g.home_team_abbr)} <small>${escapeHtml(statusText)}</small></span>`;
        }
      }).join(' ');
      scoresContent.innerHTML = label + chips;
    }
  } catch (e) { /* keep placeholder */ }
}

fetchHeadlines();
fetchScores();
setInterval(fetchScores, 60000);

function switchToChat() {
  if (chatActive) return;
  chatActive = true;
  landingEl.classList.add('hidden');
  chatViewEl.classList.add('active');
  // Move the form into the chat input area
  chatInputArea.appendChild(form);
  input.focus();
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const question = input.value.trim();
  if (!question) return;

  switchToChat();

  addMessage(question, 'user');
  const historySnapshot = conversationHistory.slice(-10);
  conversationHistory.push({ role: 'user', content: question });
  input.value = '';
  sendBtn.disabled = true;

  // Add bouncing basketball loader
  const loader = document.createElement('div');
  loader.className = 'loading';
  loader.innerHTML = `
    <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
      <circle cx="24" cy="24" r="20" fill="#D4782F"/>
      <circle cx="24" cy="24" r="20" stroke="#2D2D2D" stroke-width="1.2" fill="none"/>
      <line x1="4" y1="24" x2="44" y2="24" stroke="#2D2D2D" stroke-width="1"/>
      <line x1="24" y1="4" x2="24" y2="44" stroke="#2D2D2D" stroke-width="1"/>
      <path d="M24 4 C16 12, 16 36, 24 44" stroke="#2D2D2D" stroke-width="1" fill="none"/>
      <path d="M24 4 C32 12, 32 36, 24 44" stroke="#2D2D2D" stroke-width="1" fill="none"/>
      <ellipse cx="19" cy="18" rx="3" ry="4" fill="rgba(255,255,255,0.18)" transform="rotate(-25 19 18)"/>
    </svg>
    <div class="ball-shadow"></div>
    <span class="loading-text">Thinking...</span>
  `;
  messagesEl.appendChild(loader);
  scrollToBottom();

  try {
    const res = await fetch('/ask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        question,
        message_history: historySnapshot,
      }),
    });
    if (!res.ok) throw new Error(`Server error: ${res.status}`);
    const data = await res.json();
    loader.remove();
    addAssistantMessage(data);
    conversationHistory.push({ role: 'assistant', content: data.answer || '' });
  } catch (err) {
    loader.remove();
    addAssistantMessage({
      answer: 'Something went wrong. Make sure the backend is running.',
      category: null
    });
  } finally {
    sendBtn.disabled = false;
    input.focus();
  }
});

function addMessage(text, role) {
  const div = document.createElement('div');
  div.className = `message ${role}`;
  div.textContent = text;
  messagesEl.appendChild(div);
  scrollToBottom();
}

function addAssistantMessage(data) {
  const div = document.createElement('div');
  div.className = 'message assistant';
  let html = '';

  if (data.category) {
    const labels = {
      stats:'Stats', news:'News', mixed:'Mixed',
      betting:'Betting', off_topic:'Off Topic', error:'Error'
    };
    html += `<div class="category-badge">${labels[data.category] || data.category}</div>`;
  }

  if (data.answer) {
    html += `<div>${formatAnswer(data.answer)}</div>`;
  }

  if (data.sql) {
    html += `<details style="margin-top:10px;cursor:pointer;">
      <summary style="font-size:0.78rem;color:var(--text-light);font-weight:500;">Show SQL</summary>
      <div class="sql-block">${escapeHtml(data.sql)}</div>
    </details>`;
  }

  if (data.sources && data.sources.length > 0) {
    html += '<div class="sources"><strong>Sources:</strong> ';
    html += data.sources.map(s =>
      s.url ? `<a href="${escapeHtml(s.url)}" target="_blank">${escapeHtml(s.title||s.source)}</a>` : escapeHtml(s.title||s.source)
    ).join(' &middot; ');
    html += '</div>';
  }

  div.innerHTML = html;
  messagesEl.appendChild(div);
  scrollToBottom();
}

function formatAnswer(text) {
  return marked.parse(text);
}

function escapeHtml(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function scrollToBottom() {
  messagesEl.scrollTop = messagesEl.scrollHeight;
}
</script>
</body>
</html>
